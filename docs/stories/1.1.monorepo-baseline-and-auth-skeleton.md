# Story 1.1: Monorepo Baseline and Auth Skeleton

## Status
- Ready for Review

## Story
**As a** developer,  
**I want** a FastAPI monorepo skeleton with auth, worker, and tooling scaffolds,  
**so that** the team can enforce secure, role-aware access while sharing core services across the platform.

## Acceptance Criteria
1. Repo contains FastAPI app, worker stub, shared models, and Docker Compose with Postgres/Redis.
2. JWT auth middleware issues and validates tokens with role claims (`student`, `advisor`, `admin`).
3. CI pipeline runs lint and unit tests on pull requests.
4. Health endpoint and logging format follow observability conventions.

## Tasks / Subtasks
- [x] Scaffold Python 3.12 FastAPI monorepo structure (`src/api`, `src/workers`, `src/domain`, `src/core`, `src/infrastructure`, `tests/**`) with a minimal app factory, shared domain package, and worker entrypoint aligned to the documented source tree. (AC: 1) [Source: architecture/source-tree.md#source-tree]
  - [x] Create `pyproject.toml` with FastAPI, Pydantic v2, SQLAlchemy async, structlog, RQ, and other baseline dependencies called out in the tech stack, ensuring versions match. (AC: 1) [Source: architecture/tech-stack.md#technology-stack-table]
  - [x] Add placeholder domain models module exporting `User`, `RoleCatalog`, and `Assessment` entities that mirror the architecture data model names for later implementation. (AC: 1) [Source: architecture/data-models.md#data-models]
- [x] Configure Docker Compose for local development with app, worker, Postgres 15.5, and Redis 7.2 containers plus required environment wiring. (AC: 1) [Source: architecture/infrastructure-and-deployment.md#infrastructure-and-deployment]
  - [x] Provide seed `.env.example` containing JWT secret placeholder, Postgres DSN, Redis URL, and OpenAI key slots referenced across services. (AC: 1) [Source: architecture/tech-stack.md#technology-stack-table]
- [x] Implement JWT auth skeleton using PyJWT: dependency that validates bearer tokens, enforces role claims (`student`, `advisor`, `admin`), and issues tokens for smoke testing. (AC: 2) [Source: architecture/security-simplified-standards.md#security-simplified-standards]
  - [x] Register shared auth utility module under `src/api/deps.py` to inject current user context and enforce roles via FastAPI dependency overrides. (AC: 2) [Source: architecture/components.md#api-gateway--auth-layer]
- [x] Add structured logging setup at application startup using structlog JSON formatter and include correlation identifiers called out in the error-handling conventions. (AC: 4) [Source: architecture/error-handling-strategy.md#error-handling-strategy]
  - [x] Expose `GET /health` route returning service, version, datastore connectivity checks, and log a structured message when probed to validate observability wiring. (AC: 4) [Source: architecture/components.md#observability-hub]
- [x] Create async worker stub (`src/workers/worker.py`) bootstrapping Redis connection and registering placeholder job handlers for essay scoring and recommendation generation. (AC: 1) [Source: architecture/components.md#async-worker-service]
  - [x] Ensure job payloads and repository access follow the repository/unit-of-work abstractions described for the data layer. (AC: 1) [Source: architecture/components.md#data--repository-layer]
- [x] Set up GitHub Actions workflow (`.github/workflows/ci.yml`) running ruff linting, pytest unit tests, and OpenAPI export validation on pull requests. (AC: 3) [Source: architecture/test-strategy-and-standards.md#test-strategy-and-standards]
  - [x] Include Docker-based integration test job scaffold (allowed to be skipped initially) to align with continuous testing expectations. (AC: 3) [Source: architecture/test-strategy-and-standards.md#test-strategy-and-standards]
- [x] Document local developer bootstrap steps in `README.md` covering poetry install, Docker Compose commands, and initial migration placeholders. (AC: 1,4) [Source: architecture/infrastructure-and-deployment.md#infrastructure-and-deployment]

## Dev Notes
### Previous Story Insights
- No previous story exists in this epic; no carry-over insights required.

### Data Models
- Core entities that the skeleton must accommodate include `User`, `RoleCatalog`, and `Assessment`, which underpin access control and assessment lifecycle sharing between API and workers. [Source: architecture/data-models.md#data-models]
- Early schemas should anticipate question snapshots and async job tracking to align with downstream flows once implemented. [Source: architecture/database-schema.md#database-schema]

### API Specifications
- Future primary routes include assessment intake (`POST /assessments/start`) and response submission; structure the FastAPI router to match the documented OpenAPI paths for eventual implementation. [Source: architecture/rest-api-spec.md#rest-api-spec]
- External integrations (OpenAI, partner webhooks) are accessed via adapter modules; even in the skeleton, isolate client creation so later jobs can follow the documented patterns. [Source: architecture/external-apis.md#external-apis]
- No specific architecture guidance found for health endpoint payload shape; ensure implementation remains lightweight and observable.

### Component Specifications
- The API Gateway & Auth layer handles JWT validation, rate limiting, and routing; scaffolding should expose dependency injection patterns that make role enforcement straightforward. [Source: architecture/components.md#api-gateway--auth-layer]
- Async Worker Service relies on Redis-backed RQ jobs; provide a baseline worker entrypoint that can enqueue/dequeue tasks consistent with the architecture diagram. [Source: architecture/components.md#async-worker-service]
- Observability Hub consumes logs/metrics from both API and worker processes; follow structlog configuration so health checks and startup logs emit JSON with component metadata. [Source: architecture/components.md#observability-hub]

### File Locations
- Place FastAPI app under `src/api`, workers under `src/workers`, shared domain code in `src/domain`, and tests in `tests/unit` and `tests/integration` per the documented source tree to keep future stories aligned. [Source: architecture/source-tree.md#source-tree]

### Testing Requirements
- Tests should use pytest with Arrange-Act-Assert style, maintain coverage expectations, and live in `tests/unit` for module-level checks and `tests/integration` for Docker-backed flows. [Source: architecture/test-strategy-and-standards.md#test-strategy-and-standards]
- CI must block on lint and tests, with OpenAPI diff validation integrated once routes are added. [Source: architecture/test-strategy-and-standards.md#test-strategy-and-standards]

### Technical Constraints
- Use Python 3.12.2 with FastAPI 0.110.2, async SQLAlchemy 2.0.25, structlog 24.1.0, RQ 1.15.1, and associated stack versions defined in the tech stack table. [Source: architecture/tech-stack.md#technology-stack-table]
- Adopt structlog JSON logging with correlation identifiers and avoid plain `print` per error handling standards. [Source: architecture/error-handling-strategy.md#error-handling-strategy]
- Apply JWT authentication with role claims, bcrypt hashing, rate limiting via slowapi, and secure secret management via `.env` locally and platform variables in production. [Source: architecture/security-simplified-standards.md#security-simplified-standards]
- Local environment should rely on Docker Compose to mirror staging/production topologies and support Postgres/Redis provisioning. [Source: architecture/infrastructure-and-deployment.md#infrastructure-and-deployment]

### Project Structure Notes
- Monorepo structure and modular separation (API, workers, repositories) must remain consistent with the modular monolith architecture so later epics can extend without rework. [Source: architecture/high-level-architecture.md#high-level-overview]
- Repository/unit-of-work pattern is mandatory for persistence; even scaffolding should respect this through placeholder abstractions. [Source: architecture/components.md#data--repository-layer]

### Testing
- Unit tests live in `tests/unit/<module>/test_<subject>.py` using pytest and pytest-mock, while integration tests run in `tests/integration/` with Dockerized Postgres/Redis fixtures; ensure CI workflows execute lint → unit → integration as documented. [Source: architecture/test-strategy-and-standards.md#test-strategy-and-standards]

## Change Log
| Date       | Version | Description    | Author              |
|------------|---------|----------------|---------------------|
| 2025-10-14 | 0.1     | Initial draft. | Scrum Master Agent. |

## Dev Agent Record
### Agent Model Used
- `dev` (James · Full Stack Developer)

### Debug Log References
- None

### Completion Notes
- Established FastAPI monorepo skeleton with shared domain models, structlog wiring, Docker Compose stack, JWT auth dependencies, and worker/job placeholders aligned to architecture guidance.
- Added CI workflow, OpenAPI export script, README bootstrap steps, and unit tests covering auth token round-trip plus health endpoint.
- Validations: `ruff check`, `python -m pytest`

### File List
- .env.example
- .github/workflows/ci.yml
- README.md
- docker-compose.yml
- docs/api/openapi.json
- infra/docker/Dockerfile.api
- infra/docker/Dockerfile.worker
- pyproject.toml
- scripts/export_openapi.py
- scripts/run-tests.sh
- src/api/deps.py
- src/api/main.py
- src/api/routes/health.py
- src/api/routes/__init__.py
- src/core/auth.py
- src/core/config.py
- src/core/logging.py
- src/domain/__init__.py
- src/domain/models.py
- src/infrastructure/repositories/__init__.py
- src/infrastructure/repositories/unit_of_work.py
- src/workers/__init__.py
- src/workers/jobs.py
- src/workers/worker.py
- tests/unit/test_api_health.py
- tests/unit/test_auth.py

### Change Log
- 2025-10-14: Initial implementation of monorepo baseline, auth skeleton, observability, worker stubs, CI, and developer tooling.

## QA Results
- _Populated during QA review._
