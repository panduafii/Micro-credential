# Story 3.1: RAG Retrieval Service

## Implementation Summary

**Status**: âœ… Completed  
**Date**: 2024-12-30  
**Tests**: 12 unit tests passing

## Overview

Story 3.1 implements a keyword-based Retrieval-Augmented Generation (RAG) service that provides role-aware course recommendations based on assessment results. The service uses TF-IDF style keyword matching against a local Udemy courses dataset.

## Components Created

### 1. RAGService (`src/domain/services/rag.py`)

The core service providing:
- **Role-aware query building**: Maps roles to relevant keywords
- **Keyword-based retrieval**: TF-IDF style matching against course titles and subjects
- **Relevance scoring**: Considers keyword matches, popularity, and review count
- **Fallback mechanism**: Returns popular courses when no matches found

### 2. Data Structures

```python
@dataclass
class CourseMatch:
    course_id: str
    title: str
    url: str | None
    relevance_score: float
    match_reason: str
    metadata: dict | None = None

@dataclass
class RAGResult:
    query: str
    matches: list[CourseMatch]
    degraded: bool = False
    error: str | None = None
```

## Key Features

### AC1: RAG Query Composition
- Composes queries from track tags (role keywords)
- Incorporates profile signals from responses
- Extracts keywords from essay content

### AC2: Top-K Recommendations
- Returns configurable top-K results (default: 5)
- Includes course metadata: title, URL, subject, level, subscribers
- Relevance scores normalized 0-1

### AC3: Structured Traces
- Logs query used for retrieval
- Records match count and timing
- Enables debugging and optimization

### AC4: Static Fallback
- Activates when retrieval returns no matches
- Returns popular courses in related subject areas
- Sets `degraded=True` flag for transparency

## Role-Keyword Mappings

```python
ROLE_KEYWORDS = {
    "backend-engineer": ["python", "java", "node", "api", "database"],
    "frontend-engineer": ["javascript", "react", "vue", "angular", "css"],
    "data-scientist": ["python", "machine learning", "data", "statistics", "pandas"],
    "devops-engineer": ["docker", "kubernetes", "aws", "ci/cd", "terraform"],
    "mobile-developer": ["ios", "android", "flutter", "react native", "swift"],
}
```

## Usage Example

```python
from src.domain.services.rag import RAGService

service = RAGService(session)

result = await service.retrieve_recommendations(
    assessment_id="assess-123",
    role_slug="backend-engineer",
    profile_signals={"experience": "python", "interest": "api design"},
    essay_keywords=["microservices", "scalability"],
    top_k=5,
)

for match in result.matches:
    print(f"{match.title} - Score: {match.relevance_score}")
```

## Testing

```bash
poetry run pytest tests/unit/test_rag_service.py -v
```

### Test Coverage
- Query building for different roles
- Profile signals integration
- Essay keyword extraction
- Relevance calculation
- Fallback behavior
- Top-K enforcement

## Related Files

- Service: [src/domain/services/rag.py](../../src/domain/services/rag.py)
- Dataset: [src/infrastructure/repositories/udemy_courses.csv](../../src/infrastructure/repositories/udemy_courses.csv)
- Tests: [tests/unit/test_rag_service.py](../../tests/unit/test_rag_service.py)
