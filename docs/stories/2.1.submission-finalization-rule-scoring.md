# Story 2.1: Submission Finalization and Rule Scoring

## Status
- Completed ✅

## Story
**As a** student,  
**I want** to submit my completed assessment and receive immediate scores for theoretical/profile questions,  
**so that** I can see partial results while essay scoring happens asynchronously.

## Acceptance Criteria
1. POST /assessments/{id}/submit locks all responses (no edits after submit).
2. Rule-based scoring computes theoretical/profile scores inline and returns them in response.
3. Essay questions are queued to Redis for async GPT scoring.
4. Response includes `degraded: true` if any required responses are missing.
5. Async jobs (gpt, rag, fusion) are created with status `queued`.

## Implementation Summary

### Files Created/Modified
- `src/domain/services/submission.py` - SubmissionService with rule-based scoring logic
- `src/api/routes/assessments.py` - POST /{id}/submit endpoint
- `src/api/schemas/assessments.py` - AssessmentSubmitResponse, SubmissionScores schemas
- `src/infrastructure/db/models.py` - Score, AsyncJob models
- `alembic/versions/202412250003_add_scores_table.py` - Scores table migration
- `alembic/versions/202412250004_add_async_jobs_table.py` - AsyncJobs table migration
- `tests/unit/test_assessment_submission.py` - 15 unit tests

### Key Features
1. **Response Locking**: Assessment status changes to `submitted`, preventing further edits
2. **Rule-Based Scoring**:
   - Theoretical: Correct answer = weight points, incorrect = 0
   - Profile: All responses get full weight (no right/wrong)
3. **Degraded Mode**: If any responses are missing, `degraded: true` flag is set
4. **Async Job Queue**: Creates jobs for GPT essay scoring, RAG recommendations, and fusion

### API Response Structure
```json
{
  "assessment_id": "uuid",
  "status": "submitted",
  "submitted_at": "2025-12-29T10:00:00Z",
  "degraded": false,
  "scores": {
    "theoretical": {"total": 300, "max": 500, "count": 5, "percentage": 60.0},
    "profile": {"total": 400, "max": 400, "count": 4, "percentage": 100.0},
    "essay": {"status": "pending_gpt", "count": 1}
  },
  "jobs_queued": ["gpt", "rag", "fusion"]
}
```

### Error Handling
- 404: Assessment not found
- 403: Assessment not owned by user
- 409: Assessment already submitted
- 410: Assessment expired

## Tests
- 15 tests covering success, error cases, scoring logic, and async job creation
- All tests passing ✅

## Change Log
| Date       | Version | Description                    | Author              |
|------------|---------|--------------------------------|---------------------|
| 2025-12-29 | 1.0     | Implementation completed       | Dev Agent           |
