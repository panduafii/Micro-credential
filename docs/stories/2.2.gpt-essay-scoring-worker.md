# Story 2.2: GPT Essay Scoring Worker

## Status
- Completed ✅

## Story
**As a** student,  
**I want** my essay responses to be scored by GPT with detailed rubric feedback,  
**so that** I receive meaningful evaluation of my written work.

## Acceptance Criteria
1. Worker picks up `gpt` job from queue and calls OpenAI API with essay + rubric prompt.
2. Scores (0-100) per rubric dimension are persisted to the scores table.
3. Job status updates to `completed` or `failed` with retry count.
4. Timeout and rate-limit handling with exponential backoff.
5. Partial failures (some essays scored, some failed) are handled gracefully.

## Implementation Summary

### Files Created/Modified
- `src/domain/services/gpt_scoring.py` - GPTScoringService with retry logic
- `src/infrastructure/gpt_client.py` - GPTClient for OpenAI API calls
- `src/core/config.py` - Added GPT configuration settings
- `tests/unit/test_gpt_scoring.py` - 9 unit tests

### Key Features
1. **Rubric-Based Scoring**: Essays evaluated on 4 dimensions:
   - Relevance (0-25): How well the answer addresses the question
   - Depth (0-25): Level of detail and analysis
   - Clarity (0-25): Writing quality and organization
   - Technical (0-25): Accuracy of technical concepts

2. **Retry Logic**: 
   - Max 3 retries with exponential backoff
   - Handles timeout (30s default) and rate limit errors
   - Job marked `failed` after max retries exceeded

3. **GPT Response Parsing**:
   - Extracts JSON from markdown code blocks
   - Clamps scores to valid range (0-100)
   - Handles malformed responses gracefully

### GPT Prompt Structure
```
System: Expert essay evaluator with rubric scoring guidelines
User: Question prompt + Student's essay answer
Response: JSON with scores per dimension and brief feedback
```

### Score Persistence
- Individual scores per rubric dimension saved to `scores` table
- Score type: `essay_gpt`
- Links to question_snapshot_id for traceability

### Error Handling
- GPTTimeoutError: Request exceeded timeout
- GPTRateLimitError: API rate limit hit
- GPTResponseError: Invalid/malformed response
- All errors logged with correlation IDs

## Tests
- 9 tests covering GPT scoring, response parsing, error handling
- All tests passing ✅

## Change Log
| Date       | Version | Description                    | Author              |
|------------|---------|--------------------------------|---------------------|
| 2025-12-29 | 1.0     | Implementation completed       | Dev Agent           |
