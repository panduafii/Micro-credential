# Story 2.3: Status Polling, Webhooks, and Idempotency

## Status
- Completed ✅

## Story
**As a** student or integration partner,  
**I want** to poll assessment status, register webhooks for completion callbacks, and prevent duplicate submissions,  
**so that** I can track progress and integrate reliably with the platform.

## Acceptance Criteria
1. GET /assessments/{id}/status returns stage-by-stage progress (rule-score, gpt, rag, fusion) and overall percentage.
2. Optional webhook URL can be stored for callback on assessment completion.
3. Idempotency keys enforced on submissions to prevent duplicate processing.

## Implementation Summary

### Files Created/Modified
- `src/domain/services/status.py` - StatusService for progress tracking and webhook registration
- `src/api/routes/assessments.py` - Added GET /{id}/status, POST /{id}/webhook endpoints
- `src/api/schemas/assessments.py` - JobProgress, StageProgress, AssessmentStatusResponse, WebhookRegisterRequest/Response
- `src/infrastructure/db/models.py` - Added webhook_url and idempotency_key columns to Assessment
- `src/domain/services/submission.py` - Added idempotency key validation, DuplicateSubmissionError
- `alembic/versions/202412250006_add_webhook_and_idempotency.py` - Migration for new columns
- `tests/unit/test_status_and_webhooks.py` - 10 unit tests

### Key Features

#### 1. Status Polling (GET /assessments/{id}/status)
Returns detailed progress information:
```json
{
  "assessment_id": "uuid",
  "status": "submitted",
  "overall_progress": 50.0,
  "stages": [
    {"name": "rule_score", "status": "completed", "percentage": 100.0},
    {"name": "gpt", "status": "completed", "percentage": 100.0},
    {"name": "rag", "status": "queued", "percentage": 0.0},
    {"name": "fusion", "status": "queued", "percentage": 0.0}
  ],
  "jobs": [
    {"job_type": "gpt", "status": "completed", "created_at": "...", "completed_at": "..."},
    {"job_type": "rag", "status": "queued", "created_at": "..."}
  ]
}
```

**Stage Weights** (for overall progress calculation):
- rule_score: 20%
- gpt: 30%
- rag: 30%
- fusion: 20%

#### 2. Webhook Registration (POST /assessments/{id}/webhook)
```json
// Request
{"webhook_url": "https://example.com/callback"}

// Response
{
  "assessment_id": "uuid",
  "webhook_url": "https://example.com/callback",
  "registered_at": "2025-12-29T10:00:00Z"
}
```
- URL validated as valid HTTP/HTTPS URL
- Stored in assessment record for future callback

#### 3. Idempotency Keys (Idempotency-Key header)
- Optional header on POST /assessments/{id}/submit
- If provided, prevents duplicate submissions with same key
- Returns 409 Conflict if key already used

### Database Changes
```sql
ALTER TABLE assessments ADD COLUMN webhook_url VARCHAR(512);
ALTER TABLE assessments ADD COLUMN idempotency_key VARCHAR(64) UNIQUE;
CREATE INDEX ix_assessments_idempotency_key ON assessments(idempotency_key);
```

### Error Handling
- 404: Assessment not found
- 403: Assessment not owned by user
- 409: Duplicate idempotency key
- 422: Invalid webhook URL format

## Tests
- 10 tests covering status polling, webhook registration, idempotency
- All tests passing ✅

## Change Log
| Date       | Version | Description                    | Author              |
|------------|---------|--------------------------------|---------------------|
| 2025-12-29 | 1.0     | Implementation completed       | Dev Agent           |
