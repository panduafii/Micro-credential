# Story 3.3: Feedback Collection

## Implementation Summary

**Status**: âœ… Completed  
**Date**: 2024-12-30  
**Tests**: 9 unit tests passing

## Overview

Story 3.3 implements feedback collection capabilities, allowing students and advisors to provide ratings and comments on assessment recommendations. This data enables continuous improvement of the recommendation system.

## Components Created

### 1. FeedbackService (`src/domain/services/feedback.py`)

The core service providing:
- **Feedback submission**: Creates feedback tied to recommendations
- **Rating capture**: Relevance and acceptance ratings (1-5 scale)
- **Track tagging**: Feedback tagged by assessment track/role
- **Statistics aggregation**: Aggregate metrics for dashboards

### 2. Database Models

```python
class Feedback(Base):
    __tablename__ = "feedbacks"
    
    id: Mapped[str]
    recommendation_id: Mapped[str]  # FK to recommendations
    user_id: Mapped[str]
    user_role: Mapped[str]  # student, advisor
    rating_relevance: Mapped[int | None]  # 1-5
    rating_acceptance: Mapped[int | None]  # 1-5
    comment: Mapped[str | None]
    track_slug: Mapped[str | None]  # For filtering
    created_at: Mapped[datetime]
```

### 3. API Endpoint

```
POST /assessments/{assessment_id}/feedback
```

Request body:
```json
{
  "rating_relevance": 4,
  "rating_acceptance": 5,
  "comment": "The Python course recommendation was exactly what I needed!"
}
```

## Key Features

### AC1: Feedback Capture
- Ratings for recommendation relevance (1-5)
- Ratings for recommendation acceptance (1-5)
- Free-form comments
- All fields optional for flexibility

### AC2: Aggregated Metrics
Statistics endpoint provides:
- Total feedback count
- Average relevance rating
- Average acceptance rating
- Filterable by track

### AC3: Track Tagging
- Each feedback tagged with assessment's track/role
- Enables per-track analysis
- Supports targeted improvements

### AC4: Event Logging
- Structured logging for all feedback submissions
- Includes user role, ratings, track
- Supports audit and analytics

## API Responses

### Submit Feedback
```json
{
  "id": "feedback-uuid",
  "recommendation_id": "rec-uuid",
  "user_id": "user-123",
  "rating_relevance": 4,
  "rating_acceptance": 5,
  "comment": "Great recommendations!",
  "created_at": "2024-12-30T10:00:00Z"
}
```

### Get Statistics (Future Endpoint)
```json
{
  "track_slug": "backend-engineer",
  "total_feedback_count": 150,
  "average_relevance_rating": 4.2,
  "average_acceptance_rating": 3.8
}
```

## Service Implementation

```python
class FeedbackService:
    async def create_feedback(
        self,
        assessment_id: str,
        user_id: str,
        user_role: str,
        rating_relevance: int | None = None,
        rating_acceptance: int | None = None,
        comment: str | None = None,
    ) -> dict:
        # Verify assessment exists
        assessment = await self._get_assessment(assessment_id)
        
        # Verify recommendation exists
        recommendation = await self._get_recommendation(assessment_id)
        
        # Create feedback
        feedback = Feedback(
            recommendation_id=recommendation.id,
            user_id=user_id,
            user_role=user_role,
            rating_relevance=rating_relevance,
            rating_acceptance=rating_acceptance,
            comment=comment,
            track_slug=assessment.role_slug,
        )
        
        # Log event
        await logger.ainfo("feedback_submitted", ...)
        
        return feedback.to_dict()
```

## Error Handling

| Error | HTTP Status | Description |
|-------|-------------|-------------|
| `AssessmentNotFoundError` | 404 | Assessment doesn't exist |
| `RecommendationNotFoundError` | 404 | No recommendation for assessment |
| `ValidationError` | 422 | Invalid rating values |

## Testing

```bash
poetry run pytest tests/unit/test_feedback_service.py -v
```

### Test Coverage
- Successful feedback creation
- Assessment not found handling
- Recommendation not found handling
- Rating validation
- Optional fields behavior
- Statistics aggregation
- Track filtering

## Database Migration

Migration `202412300001_add_recommendations_tables.py` creates:
- `feedbacks` table
- Index on `recommendation_id`
- Index on `user_id`
- Index on `track_slug`

## Related Files

- Service: [src/domain/services/feedback.py](../../src/domain/services/feedback.py)
- Models: [src/infrastructure/db/models.py](../../src/infrastructure/db/models.py)
- Migration: [alembic/versions/202412300001_add_recommendations_tables.py](../../alembic/versions/202412300001_add_recommendations_tables.py)
- Tests: [tests/unit/test_feedback_service.py](../../tests/unit/test_feedback_service.py)
